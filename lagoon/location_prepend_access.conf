
location ~* ^\/(rss_v2|v1|rest\/garp-piano)\/.*$ {

  access_by_lua_block {
    local ipmatcher = require("resty.ipmatcher")
    local ip = ipmatcher.new({
      -- New CDS Data Center Achieve IP address
      "80.69.27.120",
      "80.69.27.121",
      "80.69.27.122",
      "80.69.27.123",
      "80.69.27.124",
      "80.69.27.125",
      "80.69.27.126",
      "80.69.27.127",
      "80.69.27.128",
      "80.69.27.129",
      "80.69.27.130",
      "80.69.27.131",
      "80.69.27.132",
      "80.69.27.133",
      "80.69.27.134",
      "80.69.27.135",
      "80.69.27.136",
      "80.69.27.137",
      "80.69.27.138",
      "80.69.27.139",
      "80.69.27.140",
      "80.69.27.141",
      "80.69.27.142",
      "80.69.27.143",
      "80.69.27.144",
      "80.69.27.145",
      "80.69.27.146",
      "80.69.27.147",
      "80.69.27.148",
      "80.69.27.149",
      "80.69.27.150",
      "80.69.27.151",
      "80.69.27.152",
      "80.69.27.153",
      "80.69.27.154",
      "80.69.27.155",
      "80.69.27.156",
      "80.69.27.157",
      "80.69.27.158",
      "80.69.27.159",
      -- Infopro Digital Team VPN
      "89.107.56.12",
      -- PugPig whitelist
      "34.246.133.67",
      "34.248.211.53",
      "52.50.9.208",
      "52.31.35.54",
      -- Kantar
      -- Adestra
      "46.236.37.0/24",
      "185.54.72.0/24",
      "185.54.73.0/24",
      "185.54.74.0/24",
      "185.54.75.0/24",
      "185.187.116.0/24",
      "81.29.79.128",
      "81.29.79.129",
      "81.29.79.130",
      "81.29.79.131",
      "81.29.79.132",
      "81.29.79.133",
      "81.29.79.134",
      "81.29.79.135",
      "81.29.79.136",
      "81.29.79.137",
      "81.29.79.138",
      "81.29.79.139",
      "81.29.79.140",
      "81.29.79.141",
      "81.29.79.142",
      "81.29.79.143",
      "81.29.79.144",
      "81.29.79.145",
      "81.29.79.146",
      "81.29.79.147",
      "81.29.79.148",
      "81.29.79.149",
      "81.29.79.150",
      "81.29.79.151",
      "81.29.79.152",
      "81.29.79.153",
      "81.29.79.154",
      "81.29.79.155",
      "81.29.79.156",
      "81.29.79.157",
      "81.29.79.158",
      "81.29.79.159",
      "81.29.79.160",
      "81.29.79.161",
      "81.29.79.162",
      "81.29.79.163",
      "81.29.79.164",
      "81.29.79.165",
      "81.29.79.166",
      "81.29.79.167",
      "81.29.79.168",
      "81.29.79.169",
      "81.29.79.170",
      "81.29.79.171",
      "81.29.79.172",
      "81.29.79.173",
      "81.29.79.174",
      "81.29.79.175",
      "81.29.79.176",
      "81.29.79.177",
      "81.29.79.178",
      "81.29.79.179",
      "81.29.79.180",
      "81.29.79.181",
      "81.29.79.182",
      "81.29.79.183",
      "81.29.79.184",
      "81.29.79.185",
      "81.29.79.186",
      "81.29.79.187",
      "81.29.79.188",
      "81.29.79.189",
      "81.29.79.190",
      "81.29.79.191",
      "85.199.232.226",
      "3.248.37.55",
      -- GARP
      "35.165.255.238",
      "35.167.165.16",
      "54.191.96.30",
      "52.40.196.42",
      "54.190.236.201",
      -- GCP Apps
      "34.78.49.22",
      -- City Bank RSS v2 feed access
      -- City UAT
      "159.17.175.175",
      -- City PROD
      "153.40.137.53",
      -- City COB
      "159.17.175.176",
    })

    local ipmatch, err = ip:match(ngx.var.remote_addr)

    if ipmatch then
      ngx.req.set_header("x-access", "ip")
     elseif ngx.var.http_x_varnish then
      ngx.req.set_header("x-access", "X-Varnish Header")
     elseif ngx.var.http_x_incisive_dev then
      ngx.req.set_header("x-access", "X-Incisive-Dev Header")
     elseif ngx.var.http_x_rss_access == "city-hUJ93Hm3dnKH7Wjeq8tTavtRaX4PPWfWtPG78DYbBzwy7Eq7CGCpNUQNHJdngjVz" then
      ngx.req.set_header("x-access", "x-rss-access Header")
     else
      ngx.exit(ngx.HTTP_FORBIDDEN)
    end

  }

  try_files /dev/null @drupal;
}

